# 技术实现说明

## 整体架构
项目采用三层分离架构：

桌宠交互层 (tkinter + pywin32)

↓

业务逻辑层 (Excel教学引擎 + 指令解析 + 数据管理 + UI定位)

↓

AI服务层 (本地视觉YOLO + OpenAI兼容文本/视觉API)

## 1. 桌宠交互层
基于 `tkinter` 构建透明无边框窗口，通过 `overrideredirect` 去除标题栏，`-transparentcolor` 实现背景透明，`-topmost` 保持窗口置顶，使桌宠角色可持续悬浮在桌面。项目通过 `main.py` 初始化主窗口与聊天窗口，并由 `lib/SpriteHandler.py` 统一驱动动画、交互与任务调度。

角色动画采用状态机方式切换（待机、行走、跳跃、坠落等），并在主循环中持续刷新。交互层新增了悬浮操作面板：左键可展开并拖动面板，面板内可直接输入教学问题、Excel操作指令、截图评论指令。右键菜单保留快捷入口。

针对耗时操作（AI调用、Excel批处理、截图评论），交互层使用后台线程执行，UI更新通过主线程安全回调执行，避免 `tkinter` 跨线程更新异常。

## 2. 业务逻辑层
### 教学引擎
教学流程由 `lib/ExcelHandler.py` 与 `lib/ExcelUILocator.py` 协作完成。用户输入自然语言问题后，系统结合Excel界面知识与操作语义生成可执行教学步骤，并在需要时定位界面元素，给出逐步引导。

### UI定位与视觉引导
`lib/ExcelUILocator.py` 负责枚举并识别Excel/WPS窗口，计算关键按钮和区域的相对/绝对坐标。教学模式下可根据步骤定位目标控件，为用户提供可视化引导。

### 指令解析器
`lib/ExcelHandler.py` 对用户自然语言进行结构化解析，识别操作类型并路由到对应执行器，当前包含：
- `copy`：列复制（支持“把第1列复制到第2、3列”）
- `clear`：列/区域清空
- `generate`：生成新列数据
- `transform`：对已有数据批量转换

### Excel数据管理
`lib/ExcelDataManager.py` 基于 `pandas + openpyxl` 管理读写流程，支持列读取、单元格/区间更新、元信息获取。针对历史问题已增强：
- 写入前进行类型兼容处理，降低 `dtype` 不匹配告警/风险
- 保存失败（文件占用）时自动回退到带时间戳的新文件，避免任务中断

## 3. AI服务层
AI层采用“本地优先、远端兜底”的双通道策略，由 `lib/CommentGenerator.py` 统一编排。

### 本地视觉通道
`lib/LocalExcelVision.py` 加载本地YOLO模型（`models/excel_ui_yolo.pt`），先裁剪Excel窗口ROI后推理，输出：
- UI元素检测摘要
- 整体是否有数据
- 指定列（第N列/A列）是否有数据

该通道用于降低网络依赖并提升截图评论响应稳定性。

### 远端API通道
`lib/DashScopeAPIManager.py` 封装OpenAI兼容接口，支持：
- 文本生成：`generate_text`
- 图像理解：`process_image`（`image_url` data URL格式）
- 模型发现：`list_models`
- 批处理：`process_batch`

### 容错与稳定性
针对线上波动，AI层增加如下机制：
- Connection error识别与重试退避优化
- API临时不可用冷却窗口，避免短时间重复失败
- 本地降级回复，保障核心交互不中断

### 训练与验证工具链
视觉训练工具位于 `tools/vision/`：
- `collect_excel_weak_labels.py`：弱监督采集
- `train_excel_vision.py`：训练
- `validate_excel_vision.py`：验证
- `dataset_sanity.py`：训练/验证前数据集体检
- `test_remote_vision_api.py`：远端视觉API连通性测试

关键约束：训练与验证必须使用一致数据集路径（推荐 `datasets/excel_ui_yolo_auto/dataset.yaml`），否则可能出现 `mAP=0`、`recall=0` 的假失败。

## 4. 技术栈总览
- 桌面与交互：`tkinter`、`pywin32`
- 数据处理：`pandas`、`openpyxl`
- AI接口：`openai`（OpenAI兼容API）
- 本地视觉：`ultralytics`、`opencv-python`、`numpy`
- 语音反馈：`pyttsx3`
- 图像处理：`Pillow`
